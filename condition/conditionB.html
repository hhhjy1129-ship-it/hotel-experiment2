<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="robots" content="noindex,nofollow" />
  <title>实验页 B · 一张“未来30天内超低价” + 一张“过去30天内超低价”</title>
  <style>
    :root{--card-gap:16px}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#f8fafc;color:#1e293b}
    .banner{position:sticky;top:0;background:#ef4444;color:white;text-align:center;padding:8px;font-weight:800;z-index:60}
    .filters{
      position:sticky; top:36px;
      padding: calc(8px + env(safe-area-inset-top)) 12px 8px;
      background:linear-gradient(#ffffff, #ffffffee);
      border-bottom:1px solid #eef2f7; backdrop-filter:saturate(180%) blur(8px);
      display:flex; gap:8px; overflow:auto; white-space:nowrap; z-index:50;
    }
    .chip{padding:8px 12px;border-radius:999px;border:1px solid #dbe3ee;background:#fff;font-weight:700;font-size:14px}
    .chip.active{border-color:#0ea5e9;box-shadow:0 0 0 2px rgba(14,165,233,.15) inset}
    .wrap{max-width:1100px;margin:20px auto;padding:0 16px}

    .hotel{display:grid;grid-template-columns:320px 1fr 170px;gap:var(--card-gap);border:1px solid #e2e8f0;border-radius:16px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:12px}
    .hotel + .hotel{margin-top:14px}
    .imgwrap{position:relative;border-radius:12px;overflow:hidden}
    .img{width:100%;height:200px;object-fit:cover;display:block;background:#e5e7eb}
    .fav{position:absolute;right:10px;top:10px;width:38px;height:38px;border-radius:999px;border:1px solid #e2e8f0;background:#fff;display:grid;place-items:center;box-shadow:0 4px 10px rgba(0,0,0,.1);cursor:pointer}
    .fav::before{content:"\2661";color:#64748b;font-size:20px;line-height:1}
    .fav.active::before{content:"\2665";color:#ef4444}

    .title{font-size:22px;font-weight:900;margin:0 0 6px}
    .score{display:flex;align-items:center;gap:8px;color:#065f46}
    .dots{letter-spacing:1px}
    .meta{color:#64748b}
    .ranking{margin:8px 0;color:#b91c1c;font-weight:700;font-size:14px;border:1px solid #fca5a5;border-radius:6px;padding:4px 6px;display:inline-block}
    .bullets{margin:8px 0 0 0;padding:0 0 0 22px}
    .bullets li{margin:4px 0}

    .right{display:grid;align-content:center;justify-items:end;gap:8px}
    .price-row{display:flex;align-items:baseline;gap:.6rem;flex-wrap:wrap}
    .price .currency{font-weight:800;font-size:1.1rem;line-height:1}
    .price .amount{font-weight:900;font-size:1.8rem;line-height:1}
    .price-badge{
      padding:.35rem .6rem;border-radius:999px;
      font-size:.85rem;font-weight:800;line-height:1;
      background:#16a34a;color:#fff;box-shadow:0 2px 6px rgba(22,163,74,.25);white-space:nowrap
    }
    .refund{font-size:13px;color:#065f46;line-height:1.2;text-align:right}
    .cta{background:#22c55e;color:#052e16;border:0;border-radius:999px;padding:12px 16px;font-weight:900;cursor:pointer}
    .cta[disabled]{opacity:.6;cursor:not-allowed}

    @media (max-width: 720px){
      .hotel{grid-template-columns:1fr;gap:12px}
      .img{height:200px}
      .right{justify-items:start}
      .refund{text-align:left}
      .price .amount{font-size:1.6rem}
      .price-badge{font-size:.75rem;padding:.28rem .5rem}
    }
  </style>
</head>
<body>
  <div class="banner">DEMO / 实验页面 B —— 仅用于实验，不提供真实预订服务</div>
  <div class="filters">
    <button class="chip active">价格</button>
    <button class="chip">评分 4.5+</button>
    <button class="chip">可退</button>
    <button class="chip">含早</button>
    <button class="chip">地铁附近</button>
    <button class="chip">有优惠</button>
  </div>
  <div class="wrap">
    <div id="list"></div>
  </div>

  <script>
    // ======= Google Apps Script 日志上报 URL（已替换为你给的新地址）=======
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwcmJJrXCdlUroUaXJvNRdQvjxi9hMwdAPQe6Kqkm5z3TqCVpNHLgoLjuFNK4Sedcbu/exec";

    const CONDITION = 'B'; // Future/Past
    const SAME_PRICE = 'US$301';
    const REVIEW_COUNT = 324;
    const RATING = '4.5';

    // 绑定：Palm Tree Inn = future；Rotex Western = past
    const HOTEL_FUTURE = { id:'A', name:'Palm Tree Inn', img:'hotel1.jpg', tags:['精品','古雅','浪漫'], isFuture:true };
    const HOTEL_PAST   = { id:'B', name:'Rotex Western Inn', img:'hotel2.jpg', tags:['安静','舒适','便捷'], isFuture:false };

    const qs = new URLSearchParams(location.search);
    let seed = parseInt(qs.get('seed')||Date.now().toString().slice(-6),10);
    const subj = qs.get('subj') || '';
    const TEST_MODE = !subj;
    const LOCK_KEY = subj ? `choice_lock_${subj}` : 'choice_lock_tmp';

    if(qs.get('reset')==='1'){ localStorage.removeItem(`choice_lock_${subj}`); sessionStorage.removeItem('choice_lock_tmp'); }

    function isLocked(){
      try{
        return TEST_MODE
          ? JSON.parse(sessionStorage.getItem(LOCK_KEY)||'null')
          : JSON.parse(localStorage.getItem(LOCK_KEY)||'null');
      }catch(e){ return null; }
    }
    function setLock(payload){
      if(TEST_MODE) sessionStorage.setItem(LOCK_KEY, JSON.stringify(payload));
      else localStorage.setItem(LOCK_KEY, JSON.stringify(payload));
    }

    let x = seed || 123456789;
    function rnd(){ x^=x<<13; x^=x>>>17; x^=x<<5; return (x>>>0)/4294967295; }
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

    function genCode(seedStr){
      let h = 2166136261;
      for (let i=0;i<seedStr.length;i++){ h ^= seedStr.charCodeAt(i); h = (h>>>0)*16777619; }
      const n = (h>>>0) % 1000000;
      return 'H' + String(n).padStart(6,'0');
    }
    async function copy(text){ try{ await navigator.clipboard.writeText(text); }catch(e){} }

    function logClick({subj, condition, hotel, isFuture, code}){
      if(!GAS_URL) return;
      fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({ subj, condition, hotel, isFuture, code, ts: Date.now() })
      }).catch(()=>{});
    }

    function labelText(isFuture){ return isFuture ? '未来30天内超低价' : '过去30天内超低价'; }

    function makeCard(hotel){
      const el = document.createElement('div');
      el.className = 'hotel';
      const priceCurrency = (SAME_PRICE.match(/^[A-Z]*\$/)?.[0] || 'US$');
      const priceAmount = (SAME_PRICE.match(/\d+/)?.[0] || '301');

      el.innerHTML = `
        <div class="imgwrap">
          <img class="img" src="${hotel.img}" alt="${hotel.name}">
          <div class="fav" title="收藏"></div>
        </div>
        <div class="mid">
          <h3 class="title">${hotel.name}</h3>
          <div class="score"><span>${RATING}</span><span class="dots">●●●●●◐</span><span class="meta">（${REVIEW_COUNT.toLocaleString()} 条点评）</span></div>
          <span class="ranking">在洛杉矶的 1,051 处住宿中排行榜前十</span>
          <ul class="bullets"><li>关键词：${hotel.tags.join(' ・ ')}</li></ul>
        </div>
        <div class="right">
          <div class="price-row">
            <div class="price"><span class="currency">${priceCurrency}</span><span class="amount">${priceAmount}</span></div>
            <span class="price-badge">${labelText(hotel.isFuture)}</span>
          </div>
          <div class="refund">可全额退款<br>无需预付款</div>
          <a class="meta" href="javascript:void(0)">查看优惠</a>
          <button class="cta">点击购买</button>
        </div>`;

      // 收藏按钮切换
      const fav = el.querySelector('.fav');
      fav.setAttribute('role','button');
      fav.setAttribute('aria-pressed','false');
      fav.addEventListener('click', ()=>{
        const on = fav.classList.toggle('active');
        fav.setAttribute('aria-pressed', on ? 'true' : 'false');
      });

      el.querySelector('.cta').addEventListener('click', ()=>{
        if(isLocked()){ alert('您已提交过选择，请返回问卷继续填写。'); return; }
        const hotelName = el.querySelector('.title').textContent;
        const isFuture = hotel.isFuture; // 绑定不变
        const code = genCode(`${subj}|${CONDITION}|${hotelName}|${isFuture}`);

        setLock({ subj, condition:CONDITION, hotelName, isFuture, code, ts:new Date().toISOString() });
        const badge = el.querySelector('.price-badge');
        badge.textContent = `已记录您的选择，请填写其他问卷内容。验证码：${code}（已复制）`;
        badge.style.background = '#0ea5e9';
        badge.style.fontSize = '15px';
        document.querySelectorAll('.cta').forEach(btn=> btn.disabled = true);

        copy(code);
        logClick({subj, condition:CONDITION, hotel:hotelName, isFuture, code});
      });

      return el;
    }

    function render(){
      const list = document.getElementById('list');
      const cards = shuffle([ makeCard(HOTEL_FUTURE), makeCard(HOTEL_PAST) ]);
      list.innerHTML = '';
      cards.forEach(n=> list.appendChild(n));

      const lock = isLocked();
      if(lock){
        document.querySelectorAll('.cta').forEach(btn=> btn.disabled = true);
        document.querySelectorAll('.price-badge').forEach(b=>{
          b.textContent = `已记录您的选择：${lock.hotelName}（${lock.isFuture?'未来':'过去'}）。验证码：${lock.code}`;
          b.style.background='#0ea5e9'; b.style.fontSize='15px';
        });
      }
    }

    render();
  </script>
</body>
</html>
