<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="robots" content="noindex,nofollow" />
<title>Horizonte</title>
<script src="https://app.credamo.com/credamo/js/credamo_embed.min.js"></script>
<style>
  :root{--card-gap:16px}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB",sans-serif;background:#f8fafc;color:#1e293b}
  .topbar{position:sticky;top:0;z-index:60;background:#fff}
  .searchline{display:flex;gap:10px;padding:12px 16px;border-bottom:1px solid #eef2f7;align-items:center;overflow:auto}
  .pill{flex:0 0 auto;padding:10px 14px;border-radius:999px;border:1px solid #dbe3ee;background:#fff;font-weight:800;font-size:14px;color:#0f172a}
  .filters{display:flex;gap:10px;padding:10px 16px;border-bottom:1px solid #eef2f7;overflow:auto;white-space:nowrap;background:#fff}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid #dbe3ee;background:#fff;font-weight:700;font-size:14px}
  .chip.active{border-color:#0ea5e9;box-shadow:0 0 0 2px rgba(14,165,233,.15) inset}
  .wrap{max-width:1100px;margin:16px auto;padding:0 16px}
  .hotel{display:grid;grid-template-columns:320px 1fr max-content;gap:var(--card-gap);border:1px solid #e2e8f0;border-radius:16px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:12px}
  .hotel + .hotel{margin-top:14px}
  .imgwrap{position:relative;border-radius:12px;overflow:hidden}
  .img{width:100%;height:200px;object-fit:cover;display:block;background:#e5e7eb}
  .fav{position:absolute;right:10px;top:10px;width:38px;height:38px;border-radius:999px;border:1px solid #e2e8f0;background:#fff;display:grid;place-items:center;box-shadow:0 4px 10px rgba(0,0,0,.1);cursor:pointer}
  .fav::before{content:"\2661";color:#64748b;font-size:20px;line-height:1}
  .fav.active::before{content:"\2665";color:#ef4444}
  .title{font-size:22px;font-weight:900;margin:0 0 6px}
  .score{display:flex;align-items:center;gap:8px;color:#065f46}
  .dots{letter-spacing:1px}
  .meta{color:#64748b}
  .ranking{margin:8px 0;color:#b91c1c;font-weight:700;font-size:14px;border:1px solid #fca5a5;border-radius:6px;padding:4px 6px;display:inline-block}
  .bullets{margin:8px 0 0 0;padding:0 0 0 22px}
  .bullets li{margin:4px 0}
  .amenities{margin:6px 0 0 22px;display:flex;flex-wrap:wrap;gap:8px}
  .amenity-chip{padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-size:13px;font-weight:700;border:1px solid #e2e8f0}
  .right{display:grid;align-content:center;justify-items:end;gap:8px}
  .price-badge{display:inline-block;white-space:nowrap;text-align:center;padding:.65rem 1.05rem;border-radius:999px;font-size:1.08rem;font-weight:900;line-height:1;background:#16a34a;color:#fff;border:3px solid #15803d;box-shadow:0 6px 16px rgba(22,163,74,.28)}
  .badge-slot{display:inline-block;height:40px;min-width:11ch;visibility:hidden}
  .buy-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:flex-end}
  .price .currency{font-weight:800;font-size:1.1rem;line-height:1}
  .price .amount{font-weight:900;font-size:1.9rem;line-height:1}
  .cta{background:#22c55e;color:#052e16;border:0;border-radius:999px;padding:12px 16px;font-weight:900;cursor:pointer}
  .cta[disabled]{opacity:.6;cursor:not-allowed}
  .hotel.selected{outline:3px solid #0ea5e9;outline-offset:2px}
  .hotel.dim{opacity:.45;filter:saturate(.85)}
  .confirm-bar{position:sticky;top:0;z-index:80;background:#e0f2fe;color:#075985;padding:10px 16px;border-bottom:1px solid #bae6fd;font-weight:800}
</style>
</head>
<body>
  <div class="topbar">
    <div class="searchline">
      <div class="pill">今日入住</div><div class="pill">明日退房</div><div class="pill">1 间客房 · 2 人</div>
    </div>
    <div class="filters">
      <button class="chip active">价格</button><button class="chip">评分 4.5+</button><button class="chip">可免费取消</button>
      <button class="chip">含早餐</button><button class="chip">近地铁</button>
      <button class="chip">优惠</button>
      <button class="chip">设施</button><button class="chip">星级</button>
    </div>
  </div>

  <div class="wrap"><div id="list"></div></div>

<script>
  const CONDITION = 'B';
  const CREDAMO_ANSWER_BASE = "https://www.credamo.com/answer.html#/s/3yq6Brano";
  const CREDAMO_FALLBACK_BASE = "https://www.credamo.com/s/3yq6Brano";
  const SAME_PRICE = 'US$301';
  const REVIEW_COUNT = 324;
  const RATING = '4.5';

  const qs = new URLSearchParams(location.search);
  const subj = qs.get('subj') || '';
  const TEST_MODE = !subj;
  const LOCK_KEY = subj ? `choice_lock_${subj}` : 'choice_lock_tmp';
  if (qs.get('reset')==='1'){ localStorage.removeItem(`choice_lock_${subj}`); sessionStorage.removeItem('choice_lock_tmp'); }
  function isLocked(){ try{ return TEST_MODE ? JSON.parse(sessionStorage.getItem(LOCK_KEY)||'null') : JSON.parse(localStorage.getItem(LOCK_KEY)||'null'); }catch(e){ return null; } }
  function setLock(payload){ if(TEST_MODE) sessionStorage.setItem(LOCK_KEY, JSON.stringify(payload)); else localStorage.setItem(LOCK_KEY, JSON.stringify(payload)); }

  function genCode(){ const bytes=new Uint8Array(8); crypto.getRandomValues(bytes); let hex=''; for(const b of bytes){ hex+=('0'+b.toString(16)).slice(-2);} return 'H'+hex.slice(-12).toUpperCase(); }
  async function copyTextSafely(text){
    let ok=false;
    try{ const ta=document.createElement('textarea'); ta.value=text; ta.setAttribute('readonly',''); ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.select(); ok=document.execCommand('copy'); document.body.removeChild(ta);}catch(e){}
    if(ok) return true;
    try{ if(navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(text); return true; } }catch(e){}
    return false;
  }

  function openCredamoWith(payload){
    const params = new URLSearchParams(payload).toString();
    const url = `${CREDAMO_ANSWER_BASE}?${params}`;
    const fallback = `${CREDAMO_FALLBACK_BASE}?${params}`;
    if (window.credamoEmbed && window.credamoEmbed.initSurvey) {
      window.credamoEmbed.initStyle();
      window.credamoEmbed.initSurvey({displayType:1,rowType:2,colType:3,iconType:1,btnBg:'#3F85FA',btnText:'',isAnswerLimit:false,queryTable:[],isInternational:false,answerUrl:url,onClose:()=>{}});
    } else { location.href = fallback; }
  }

  function showConfirmBar(hotelName){
    let bar = document.querySelector('.confirm-bar');
    if(!bar){ bar = document.createElement('div'); bar.className='confirm-bar'; document.body.prepend(bar); }
    bar.textContent = `您已选择：${hotelName}。后续问题仅关于这张卡片。`;
  }
  function labelByType(type){
    if(type==='PAST')   return '过去30天内超低价';
    if(type==='FUTURE') return '未来30天内超低价';
    return '此房源超低价在售';
  }
  function makeCard(hotel, labelText, labelType){
    const el=document.createElement('div'); el.className='hotel';
    const priceCurrency=(SAME_PRICE.match(/^[A-Z]*\$/)?.[0]||'US$');
    const priceAmount=(SAME_PRICE.match(/\d+(?:\.\d+)?/)?.[0]||'301');
    const badgeHTML = labelText ? `<span class="price-badge">${labelText}</span>` : `<span class="badge-slot" aria-hidden="true"></span>`;
    el.innerHTML=`
      <div class="imgwrap">
        <img class="img" src="${hotel.img}" alt="${hotel.name}">
        <div class="fav" title="收藏"></div>
      </div>
      <div class="mid">
        <h3 class="title">${hotel.name}</h3>
        <div class="score"><span>${RATING}</span><span class="dots">●●●●●◐</span><span class="meta">（${REVIEW_COUNT.toLocaleString()} 条点评）</span></div>
        <span class="ranking">在洛杉矶的 1,051 处住宿中排行榜前十</span>
        <ul class="bullets"><li>关键词：${hotel.tags.join(' · ')}</li></ul>
        <div class="amenities">
          ${hotel.amenityTags.map(t=>`<span class="amenity-chip">${t}</span>`).join('')}
        </div>
      </div>
      <div class="right">
        ${badgeHTML}
        <div class="buy-row">
          <div class="price"><span class="currency">${priceCurrency}</span><span class="amount">${priceAmount}</span></div>
          <button class="cta">选择</button>
        </div>
        <a class="meta" href="javascript:void(0)">查看优惠</a>
      </div>`;
    el.querySelector('.cta').addEventListener('click', ()=>{
      if(isLocked()){ alert('您已提交过选择，请返回问卷继续填写。'); return; }
      onChoose(el, hotel, labelType);
    });
    return el;
  }

  // 随机装配
  const HOTEL_SHELLS = [
    { id:'A', name:'棕榈景致酒店' },
    { id:'B', name:'海风西岸酒店' }
  ];
  const CONTENT_VARIANTS = [
    { img:'hotel1.jpg', tags:['精品','复古','浪漫'], amenityTags:['洗衣房','停车场','自助入住','智能客控'] },
    { img:'hotel2.jpg', tags:['安静','舒适','便捷'], amenityTags:['健身房','咖啡厅','24小时前台','行李寄存'] }
  ];
  const armParam   = qs.get('arm');
  const orderParam = qs.get('order');
  const swapParam  = qs.get('swap');
  function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
  const seedBase = subj ? hashStr(subj) : (Date.now()>>>0);
  const SWAP_CONTENT = (swapParam==='0'||swapParam==='1') ? Number(swapParam) : ((seedBase>>>2)&1);
  const ARM          = (armParam==='0'||armParam==='1')   ? Number(armParam)  : (seedBase & 1);
  const ORDER_FLIP   = (orderParam==='0'||orderParam==='1')?Number(orderParam): ((seedBase>>>1)&1);

  const HOTELS = [
    { ...HOTEL_SHELLS[0], ...CONTENT_VARIANTS[ SWAP_CONTENT ? 1 : 0 ] },
    { ...HOTEL_SHELLS[1], ...CONTENT_VARIANTS[ SWAP_CONTENT ? 0 : 1 ] }
  ];
  const HOTEL_TARGET = HOTELS[ARM];
  const HOTEL_FILLER = HOTELS[1-ARM];

  async function onChoose(cardEl, hotel, labelType){
    document.querySelectorAll('.hotel').forEach(h=>{
      if(h===cardEl){ h.classList.add('selected'); }
      else{ h.classList.add('dim'); h.querySelector('.cta').disabled = true; }
    });
    showConfirmBar(hotel.name);

    const code=genCode();
    setLock({subj,condition:CONDITION,hotelName:hotel.name,isFuture:(labelType==='FUTURE')?'TRUE':'FALSE',code,arm:ARM,orderFlip:ORDER_FLIP,swap:SWAP_CONTENT,ts:new Date().toISOString()});

    const badge=cardEl.querySelector('.price-badge');
    const copiedHint='（已复制）';
    if(badge){
      badge.textContent=`已记录您的选择。验证码：${code}`;
      badge.style.background='#0ea5e9'; badge.style.borderColor='#0284c7';
      badge.style.cursor='pointer'; badge.title='点击可再次复制验证码';
      const ok = await copyTextSafely(code);
      if(ok) badge.textContent=`已记录您的选择。验证码：${code}${copiedHint}`;
      badge.addEventListener('click', ()=>{ copyTextSafely(code); });
    }else{
      await copyTextSafely(code);
    }

    setTimeout(()=>openCredamoWith({
      condition: CONDITION,
      hotel: hotel.name,
      isFuture: (labelType==='FUTURE')?'TRUE':'FALSE',
      code, arm: ARM, orderFlip: ORDER_FLIP, swap: SWAP_CONTENT, subj
    }), 60);
  }

  function render(){
    const list=document.getElementById('list'); list.innerHTML='';
    const targetCard = makeCard(HOTEL_TARGET, labelByType('FUTURE'), 'FUTURE');
    const fillerCard = makeCard(HOTEL_FILLER, '', 'FILLER');
    const cards=[targetCard,fillerCard]; if(ORDER_FLIP) cards.reverse(); cards.forEach(n=>list.appendChild(n));

    const lock=isLocked();
    if(lock){
      document.querySelectorAll('.cta').forEach(btn=>btn.disabled=true);
      const badge=document.querySelector('.price-badge');
      if(badge){ badge.textContent=`已记录：${lock.hotelName}。验证码：${lock.code}`; badge.style.background='#0ea5e9'; badge.style.borderColor='#0284c7'; badge.style.cursor='pointer'; badge.title='点击可复制验证码'; badge.addEventListener('click',()=>copyTextSafely(lock.code)); }
      showConfirmBar(lock.hotelName);
    }

    if(qs.get('debug')==='1'){
      const tag=document.createElement('div');
      tag.style.cssText='position:fixed;left:10px;bottom:10px;z-index:9999;background:#111;color:#fff;padding:6px 8px;font:12px/1 monospace;border-radius:6px;opacity:.85';
      tag.textContent=`swap=${SWAP_CONTENT} arm=${ARM} order=${ORDER_FLIP} subj=${subj||'-'}`;
      document.body.appendChild(tag);
    }
  }
  render();
</script>
</body>
</html>
